name: Auto Release

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  build:
    name: Build & Publish
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 

      - name: Prepare Release Artifacts
        run: |
          # 1. Define Variables
          TAG_NAME=${{ github.ref_name }}
          ZIP_NAME="SocialFetch-${TAG_NAME}.zip"
          STAGING_DIR="SocialFetch"
          
          # 2. Create Staging Area
          mkdir $STAGING_DIR
          rsync -av --exclude='.git' --exclude="$STAGING_DIR" . $STAGING_DIR/
          
          # 3. Clean "Junk" Files
          rm -rf $STAGING_DIR/.github
          rm -rf $STAGING_DIR/assets
          rm -f  $STAGING_DIR/.gitignore
          rm -f  $STAGING_DIR/.gitattributes
          rm -f  $STAGING_DIR/README.md
          rm -f  $STAGING_DIR/CONTRIBUTING.md
          rm -f  $STAGING_DIR/SECURITY.md
          zip -r $ZIP_NAME $STAGING_DIR
          
          # 5. Generate Checksum
          sha256sum $ZIP_NAME > checksums.txt
          
          # 6. Save Variables
          echo "ZIP_NAME=$ZIP_NAME" >> $GITHUB_ENV

      - name: Publish Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            ${{ env.ZIP_NAME }}
            checksums.txt
          
          generate_release_notes: true
          append_body: true
          body: |
            ---
            **Full Changelog**: https://github.com/${{ github.repository }}/commits/${{ github.ref_name }}
            **VirusTotal Check**: `checksums.txt` included in assets.
          
          prerelease: ${{ contains(github.ref, '-') }}
          make_latest: ${{ !contains(github.ref, '-') }}